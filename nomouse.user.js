/*
// ==UserScript==
// @name NoMouse
// @namespace http://github.com/brendoncrawford/nomouse
// @description
//     Intuitive keyboard browsing. Windows users: hit
//     SHIFT+SPACEBAR to activate. OSX users: hit OPTION
//     (or ALT) to activate. To change activation key(s),
//     go to "about:config", and change "nomouse.trigger".
//     To change the labels keys, search for "nomouse.labels". While
//     holding down activation key(s), select the letters corresponding
//     to the item you want to click.
// ==/UserScript==
*/
"use strict";(function(){var b,d,c,a;c=GM_getValue;a=GM_setValue;b={};b.stackWiper=null;b.keyStack={};b.listeners=[];b.p={o:{osx:false,win:false,linux:false},b:{gecko:false,webkit:false,opera:false,ie:false}};b.map={ESC:{v:"[Esc]",p:false,k:27,s:[],c:[]},F1:{v:"F1",p:false,k:112,s:[],c:[]},F2:{v:"F2",p:false,k:113,s:[],c:[]},F3:{v:"F3",p:false,k:114,s:[],c:[]},F4:{v:"F4",p:false,k:115,s:[],c:[]},F5:{v:"F5",p:false,k:116,s:[],c:[]},F6:{v:"F6",p:false,k:117,s:[],c:[]},F7:{v:"F7",p:false,k:118,s:[],c:[]},F8:{v:"F8",p:false,k:119,s:[],c:[]},F9:{v:"F9",p:false,k:120,s:[],c:[]},F10:{v:"F10",p:false,k:121,s:[],c:[]},F11:{v:"F11",p:false,k:122,s:[],c:[]},F12:{v:"F12",p:false,k:123,s:[],c:[]},TICK:{v:"`",p:true,k:192,s:[],c:[96,126]},HYPHEN:{v:"-",p:true,k:45,s:[],c:[95,8211,8212]},PLUS:{v:"+",p:true,k:43,s:[],c:[177]},BACKSPACE:{v:"[BckSpce]",p:false,k:8,s:[],c:[]},DELETE:{v:"[Del]",p:false,k:46,s:[],c:[]},TAB:{v:"[Tab]",p:false,k:9,s:[],c:[]},BRACKET_LEFT:{v:"[",p:true,k:219,s:[],c:[91,27,123,8220,8221]},BRACKET_RIGHT:{v:"]",p:true,k:221,s:[],c:[93,29,125,8216,8217]},SLASH_BACK:{v:"\\",p:true,k:220,s:[],c:[92,28,124,171,187]},ARROW_UP:{v:"[ArrowUp]",p:false,k:38,s:[],c:[]},ARROW_DOWN:{v:"[ArrowDn]",p:false,k:40,s:[],c:[]},ARROW_LEFT:{v:"[ArrowLt]",p:false,k:37,s:[],c:[]},ARROW_RIGHT:{v:"[ArrowRt]",p:false,k:39,s:[],c:[]},SHIFT:{v:"[Shift]",p:false,k:16,s:[],c:[]},CONTROL:{v:"[Ctrl]",p:false,k:17,s:[],c:[]},ALT:{v:"[Alt]",p:false,k:18,s:[],c:[]},COMMAND:{v:"[CMD]",p:false,k:224,s:[],c:[]},A:{v:"a",p:true,k:65,s:[],c:[65,97,229,197]},B:{v:"b",p:true,k:66,s:[],c:[66,98,8747,305]},C:{v:"c",p:true,k:67,s:[],c:[67,99,231,199]},D:{v:"d",p:true,k:68,s:[],c:[68,100,8706,206]},E:{v:"e",p:true,k:69,s:[],c:[69,101,180]},F:{v:"f",p:true,k:70,s:[],c:[70,102,402,207]},G:{v:"g",p:true,k:71,s:[],c:[71,103,169,733]},H:{v:"h",p:true,k:72,s:[],c:[72,104,729,211]},I:{v:"i",p:true,k:73,s:[],c:[73,105,710]},J:{v:"j",p:true,k:74,s:[],c:[74,106,8710,212]},K:{v:"k",p:true,k:75,s:[],c:[75,107,730,63743]},L:{v:"l",p:true,k:76,s:[],c:[76,108,172,210]},M:{v:"m",p:true,k:77,s:[],c:[77,109,181,194]},N:{v:"n",p:true,k:78,s:[],c:[78,110,732]},O:{v:"o",p:true,k:79,s:[],c:[79,111,248,216]},P:{v:"p",p:true,k:80,s:[],c:[80,112,960,8719]},Q:{v:"q",p:true,k:81,s:[],c:[81,113,339,338]},R:{v:"r",p:true,k:82,s:[],c:[82,114,174,8240]},S:{v:"s",p:true,k:83,s:[],c:[83,115,223,205]},T:{v:"t",p:true,k:84,s:[],c:[84,116,8224,711]},U:{v:"u",p:true,k:85,s:[],c:[85,117,168]},V:{v:"v",p:true,k:86,s:[],c:[86,118,8730,9674]},W:{v:"w",p:true,k:87,s:[],c:[87,119,8721,8222]},X:{v:"x",p:true,k:88,s:[],c:[88,120,8776,731]},Y:{v:"y",p:true,k:89,s:[],c:[89,121,165,193]},Z:{v:"z",p:true,k:90,s:[],c:[90,122,937,184]},EQUAL:{v:"=",p:true,k:61,s:[221],c:[61,8800]},SPACE:{v:"[SpaceBar]",p:false,k:32,s:[192],c:[32,160]},ONE:{v:"1",p:true,k:49,s:[81],c:[49,33,161,8260]},TWO:{v:"2",p:true,k:50,s:[82],c:[50,64,8482,8364]},THREE:{v:"3",p:true,k:51,s:[83],c:[51,35,164,8249]},FOUR:{v:"4",p:true,k:52,s:[84],c:[52,36,162,8250]},FIVE:{v:"5",p:true,k:53,s:[85],c:[53,37,8734,64257]},SIX:{v:"6",p:true,k:54,s:[86],c:[54,94,167,64258]},SEVEN:{v:"7",p:true,k:55,s:[87],c:[55,38,182,8225]},EIGHT:{v:"8",p:true,k:56,s:[88],c:[56,42,8226,176]},NINE:{v:"9",p:true,k:57,s:[89],c:[57,40,170,183]},ZERO:{v:"0",p:true,k:48,s:[80],c:[48,41,186,8218]},SEMICOLON:{v:";",p:true,k:59,s:[219],c:[59,58,8230,218]},QUOTE_SINGLE:{v:"'",p:true,k:222,s:[71],c:[39,34,230,198]},RETURN:{v:"[Return]",p:false,k:13,s:[77,67],c:[]},COMMA:{v:",",p:true,k:188,s:[76],c:[44,60,8804,175]},PERIOD:{v:".",p:true,k:190,s:[78],c:[46,62,8805,728]},SLASH_FORWARD:{v:"/",p:true,k:191,s:[79],c:[47,63,247,191]}};
b.init=function(){var e;unsafeWindow.document.onkeypress=function(){};unsafeWindow.document.onkeydown=function(){};unsafeWindow.document.onkeyup=function(){};b.bind(document,"keypress",b.process);b.bind(document,"keydown",b.process);b.bind(document,"keyup",b.process);e=window.navigator.userAgent.toString();if(window.opera){b.p.b.opera=true;}else{if(e.match(/(khtml|safari|webkit)/i)){b.p.b.webkit=true;}else{if(e.match(/gecko/i)){b.p.b.gecko=true;}else{if(e.match(/msie/i)){b.p.b.ie=true;}}}}if(e.match(/windows/i)){b.p.o.win=true;}else{if(e.match(/macintosh/i)){b.p.o.osx=true;}else{if(e.match(/linux/i)){b.p.o.linux=true;}}}return true;};b.clearStack=function(){if(b.stackWiper!==null){window.clearTimeout(b.stackWiper);}b.stackWiper=window.setTimeout(function(){b.keyStack={};},30000);return true;};b.process=function(h){var l,f,i,g,k,j;if(h){l=h;}else{if(window.event){l=window.event;}else{return true;}}b.clearStack();f=b.getAction(l.keyCode,l.charCode);if(l.type==="keydown"&&!f.printable&&f.found&&!b.searchStack({name:f.name})){b.pushStack(f.name,f);
b.dispatch(f,"down",l);}else{if(l.type==="keypress"&&f.found){if(!b.searchStack({name:f.name})){b.pushStack(f.name,f);b.dispatch(f,"down",l);}else{b.dispatch(f,"press",l);}}else{if(l.type==="keyup"){if(f.found){i=b.searchStack({keyCode:f.keyCode});}else{i=b.searchStack({position:"last"});}b.dispatch(f,"up",l);b.popStack(i.name);if(b.p.o.win&&b.p.b.gecko){k=b.searchStack({position:"first"});j=b.searchStack({position:"last"});if(j&&j.name==="ALT"){if((f.name==="SHIFT"||f.name==="CONTROL")||(k&&k.name==="ALT")){b.dispatch(f,"up",l);b.popStack("ALT");}}}}}}return true;};b.clone=function(e){var g,h,f;if(typeof e!=="object"){return e;}else{if(e.concat){f=[];for(g=0,h=e.length;g<h;g++){f[g]=arguments.callee(e[g]);}}else{f={};for(g in e){if(e.hasOwnProperty(g)){f[g]=arguments.callee(e[g]);}}}return f;}};b.register=function(e,f,g){b.listeners[b.listeners.length]={keys:b.clone(e),type:f,callback:g};return true;};b.dispatch=function(j,o,p){var m,l,f,v,q,e,s,n,h,g,u,r;for(m=0,l=b.listeners.length;m<l;
m++){f=b.listeners[m];v=null;q=0;e=0;n=false;if((typeof f.type).toLowerCase()!=="string"){for(u=0,r=f.type.length;u<r;u++){if(f.type[u]===o){n=true;break;}}}else{if(f.type===o){n=true;}}if(n){for(v in b.keyStack){if(b.keyStack.hasOwnProperty(v)){for(h=0,g=f.keys.length;h<g;h++){if(f.keys[h]===v){q++;}}e++;}}if(q>0&&q===e&&q===f.keys.length){s=f.callback(j,o);if(!s){b.killEvent(p);return false;}else{return true;}}}}return true;};b.killEvent=function(e){if(e.preventDefault){e.preventDefault();}return true;};b.pushStack=function(e,f){b.keyStack[e]=f;return true;};b.searchStack=function(k){var g,f,e,m,j,h,n,l;if(k.names!==undefined){for(g=0,f=k.names.length;g<f;g++){if(b.keyStack[k.names[g]]!==undefined){return true;}}}else{if(k.name!==undefined){if(b.keyStack[k.name]!==undefined){return true;}}else{if(k.keyCode!==undefined){for(j in b.keyStack){if(b.keyStack.hasOwnProperty(j)){if(b.keyStack[j].keyCode===k.keyCode){return b.keyStack[j];}}}for(h in b.keyStack){if(b.keyStack.hasOwnProperty(h)){for(n=0,l=b.keyStack[h].secKeys.length;
n<l;n++){if(b.keyStack[h].secKeys[n]===k.keyCode){return b.keyStack[h];}}}}}else{if(k.position!==undefined){if(k.position==="last"){m=false;for(m in b.keyStack){if(b.keyStack.hasOwnProperty(m)){continue;}}if(m){return b.keyStack[m];}else{return false;}}if(k.position==="first"){m=false;for(m in b.keyStack){if(b.keyStack.hasOwnProperty(m)){break;}}if(m){return b.keyStack[m];}else{return false;}}}}}}return false;};b.popStack=function(e){delete b.keyStack[e];return true;};b.getAction=function(k,m){var n,j,i,q,o,h,f,g,p,e,l;p=false;main:for(h in b.map){if(b.map.hasOwnProperty(h)){n=b.map[h];for(j=0,i=n.c.length;j<i;j++){f=n.c[j];if(m===f){g={found:true,keyCode:n.k,charCode:f,secKeys:n.s,name:h,printable:n.p,val:n.v};p=true;break main;}}for(q=0,o=n.s.length;q<o;q++){l=n.s[q];if(k===l){g={found:true,keyCode:n.k,charCode:l,secKeys:n.s,name:h,printable:n.p,val:n.v};p=true;break main;}}if(n.k===k){g={found:true,keyCode:n.k,charCode:n.k,secKeys:n.s,name:h,printable:n.p,val:n.v};p=true;break main;}}}if(!p){e=(k!==0?String.fromCharCode(k):String.fromCharCode(m));
g={found:false,keyCode:k,charCode:m,secKeys:[],name:"UNKNOWN",printable:e.length?true:false,val:e};}return g;};b.bind=function(g,e,f){if(g.attachEvent){g.attachEvent("on"+e,f);}else{if(g.addEventListener){g.addEventListener(e,f,false);}}return true;};b.init();d={};d.timeout=3000;d.timer=null;d.lastNode=null;d.current="";d.nodemap={};d.zindexer=100;d.built=false;d.container=null;d.limit=1000;d.trigger=null;d.chars=null;d.keyconf={trigger:{win:"SHIFT SPACE",osx:"ALT",linux:"ALT"},labels:"J K L SEMICOLON"};d.buildContainer=function(){d.container=document.body.appendChild(document.createElement("div"));d.container.id="nomouse_container";d.container.style.display="none";d.container.style.position="absolute";d.container.style.top="0px";d.container.style.left="0px";return true;};d.arr_add=function(e,g){var f;f=b.clone(e);f[f.length]=g;return f;};d.prefs=function(){var e,h,f,l,g,k,j;j="";e=c("trigger",null);f=c("labels",null);if(e===null||e===""){if(b.p.o.osx){e=d.keyconf.trigger.osx;}else{if(b.p.o.win){e=d.keyconf.trigger.win;
}else{if(b.p.o.linux){e=d.keyconf.trigger.linux;}}}a("trigger",e);}if(f===null||f===""){f=d.keyconf.labels;a("labels",f);}h=e.split(/\W+/ig);l=f.split(/\W+/ig);b.register(h,["up","down","press"],d.toggler);for(g=0,k=l.length;g<k;g++){if(b.map[l[g]].v.length===1){b.register(d.arr_add(h,l[g]),["down","press"],d.press);j+=b.map[l[g]].v;}}b.register(["RETURN"],["down"],d.enter);return j;};d.init=function(){d.chars=d.prefs();d.buildContainer();d.buildLabels();d.built=true;return true;};d.intercept=function(){return false;};d.buildLabels=function(){var g,f,e,h;e=d.charIncrement(d.chars);g=document.evaluate("//a|//input|//select|//textarea",document,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);d.zindexer+=g.snapshotLength;for(f=0,h=g.snapshotLength;f<h&&f<d.limit;f++){d.register(g.snapshotItem(f),e.val,e.id);e=d.charIncrement(d.chars,e.val);}return true;};d.charIncrement=function(j){var f,h,k,l,n,m,g,e,o;if(!arguments[1]){return{val:j.charAt(0),id:1};}else{f=arguments[1];}h=false;k=false;
l="";e="";for(g=f.length-1;g>=0;g--){n=f.charAt(g);m=j.indexOf(n);if(g===f.length-1||h){o=m+1;h=false;}else{o=m;}if(o>=j.length){o=0;h=true;if(g===0){k=true;}}else{h=false;}l=j.charAt(o)+l;e=(o+1).toString()+e;if(k){l=j.charAt(0)+l;e=(1).toString()+e;k=false;}}return{val:l,id:parseInt(e,10)};};d.toggler=function(e,f){if(f==="down"){d.showLabels();}else{if(f==="up"){d.cleanup();if(d.lastNode!==null){d.lastNode.node.focus();}}}return false;};d.pos=function(f){var g,e;g=0;e=0;if(f.offsetParent){g=f.offsetLeft;e=f.offsetTop;while(true){f=f.offsetParent;if(!f){break;}else{g+=f.offsetLeft;e+=f.offsetTop;}}}return{left:g,top:e};};d.register=function(j,h,g){var f,e,i;i=d.pos(j);f=document.createElement("div");f.appendChild(document.createTextNode(h));f.style.position="absolute";f.style.top=i.top+"px";f.style.left=i.left+"px";f.style.fontWeight="normal";f.style.fontSize="12px";f.style.fontFamily="Courier, Courier New, Andale Mono, monospace";f.style.backgroundColor="#000000";f.style.color="#FFFFFF";
f.style.padding="1px";f.style.letterSpacing="0px";f.style.border="1px solid green";f.style.zIndex=d.zindexer;f.className="nomouse";d.container.appendChild(f);d.nodemap[g]={node:j};d.zindexer++;return true;};d.doClick=function(f){var e;e=unsafeWindow.document.createEvent("MouseEvents");e.initMouseEvent("click",true,true,unsafeWindow,1,12,345,7,220,false,false,true,false,0,null);f.dispatchEvent(e);return true;};d.press=function(e,f){if(f==="down"){d.process(e.val);}return false;};d.enter=function(e,f){if(d.lastNode!==null){d.doClick(d.lastNode.node);}return true;};d.showLabels=function(){d.container.style.display="block";return true;};d.cleanup=function(){d.container.style.display="none";d.kill();};d.process=function(f){var e,h,g;d.killTimer();d.current+=f;window.status=d.current;d.timer=window.setTimeout(d.kill,d.timeout);g=d.getCodeID(d.chars,d.current);if(d.nodemap[g]!==undefined){if(d.lastNode!==null){d.lastNode.node.style.backgroundColor=d.lastNode.backgroundColor;d.lastNode.node.style.border=d.lastNode.border;
d.lastNode.node.style.color=d.lastNode.color;d.lastNode.node.style.backgroundImage=d.lastNode.backgroundImage;}h=d.nodemap[g].node;d.lastNode={node:h,backgroundColor:h.style.backgroundColor,border:h.style.border,color:h.style.color,backgroundImage:h.style.backgroundImage};h.style.backgroundColor="#FF0";h.style.border="1px solid #F00";h.style.color="#000";h.style.backgroundImage="none";}return true;};d.getCodeID=function(h,k){var f,e,j,g;e="";for(f=0;f<k.length;f++){j=k.charAt(f);g=(h.indexOf(j)+1).toString();e+=g;}return e;};d.kill=function(){d.killTimer();d.current="";window.status=window.defaultStatus;return true;};d.killTimer=function(){if(d.timer!==null){window.clearTimeout(d.timer);d.timer=null;return true;}else{return false;}};d.init();}());